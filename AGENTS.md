# AGENTS.md - gopportunities Repository Guide

This document helps agents work effectively in the **gopportunities** repository - a Go REST API for job opportunities management built with Gin framework, GORM, and SQLite.

## Project Overview

**Type**: Go REST API  
**Framework**: Gin Web Framework  
**Database**: SQLite with GORM ORM  
**Documentation**: Swagger/OpenAPI with swag  
**Go Version**: 1.25.5

**Purpose**: REST API for managing job opening opportunities with CRUD operations and persistence.

---

## Essential Commands

### Build & Run

```bash
make run-with-docs    # Default task: generate docs and run with hot reload (port 8080)
make run              # Run without regenerating docs
make build            # Build binary to ./gopportunities executable
make clean            # Remove binary and docs directory
make docs             # Generate Swagger documentation from comments
make test             # Run tests (currently basic: go test ./ ...)
```

**Default port**: 8080 (configurable via `PORT` environment variable)

### Manual Go Commands

```bash
go run main.go                    # Run directly
go build -o gopportunities main.go  # Build to binary
swag init                         # Generate Swagger docs
```

---

## Code Organization

```
gopportunities/
├── main.go              # Entry point: initializes config and router
├── config/              # Configuration and initialization
│   ├── config.go       # Main config Init() function
│   ├── logger.go       # Custom Logger implementation
│   └── sqlite.go       # SQLite initialization and auto-migration
├── router/              # HTTP routing
│   ├── router.go       # Gin router setup (Initialize function)
│   └── routes.go       # Route definitions with handlers
├── handler/             # HTTP request handlers (business logic)
│   ├── handler.go      # Handler initialization
│   ├── createOpenining.go   # Create opening handler (POST)
│   ├── listOpenings.go      # List all openings (GET)
│   ├── showOpening.go       # Show single opening (GET)
│   ├── updateOpening.go     # Update opening (PUT)
│   ├── deleteOpening.go     # Delete opening (DELETE)
│   ├── request.go      # Request structs with Validate() methods
│   └── response.go      # Response structs and helper functions
├── schemas/             # GORM database models
│   └── opening.go       # Opening model and OpeningResponse DTO
├── docs/                # Generated Swagger documentation
│   ├── docs.go         # Swagger meta (generated by swag init)
│   ├── swagger.json    # OpenAPI JSON spec (generated)
│   └── swagger.yaml    # OpenAPI YAML spec (generated)
├── db/                  # SQLite database (ignored by git)
│   └── main.db         # Created on first run
├── go.mod              # Module declaration
├── go.sum              # Dependency checksums
└── makefile            # Build and run tasks
```

---

## Data Model & API Endpoints

### Opening Model (schemas/opening.go)

```go
type Opening struct {
    gorm.Model              // Adds ID, CreatedAt, UpdatedAt, DeletedAt
    Role     string         // Job role/title
    Company  string         // Company name
    Location string         // Job location
    Remote   *bool          // Null-safe boolean pointer for remote work
    Link     string         // External job link
    Salary   int64          // Annual salary in cents/smallest currency unit
}
```

### API Endpoints (Base path: `/api/v1/`)

| Method | Endpoint   | Handler | Description |
|--------|-----------|---------|-------------|
| POST   | `/opening` | CreateOpeningHandler | Create new job opening |
| GET    | `/opening` | ShowOpeningHandler | Show specific opening (requires ID param) |
| PUT    | `/opening` | UpdateOpeningHandler | Update existing opening |
| DELETE | `/opening` | DeleteOpeningHandler | Delete an opening |
| GET    | `/openings` | ListOpeningsHandler | List all openings |

**Swagger UI**: `http://localhost:8080/swagger/index.html`

---

## Code Patterns & Conventions

### Request Validation Pattern

All requests use a `*Request` struct with a `Validate()` error method:

```go
// handler/request.go
type CreateOpeningRequest struct {
    Role     string `json:"role"`
    Company  string `json:"company"`
    // ... other fields
}

func (r *CreateOpeningRequest) Validate() error {
    if r.Role == "" {
        return errParamIsRequired("role", "string")
    }
    // ... validation logic
    return nil
}

// Handler usage:
if err := request.Validate(); err != nil {
    sendError(ctx, http.StatusBadRequest, err.Error())
    return
}
```

**Key points**:
- Validation happens in handler **after** BindJSON
- Returns descriptive errors with field names and types
- errParamIsRequired() helper formats standard error messages

### Response Pattern

All responses use standard helpers in handler/response.go:

```go
sendSuccess(ctx, "operation-name", data)
sendError(ctx, http.StatusCode, "error message")
```

Response format:
```json
// Success
{
    "message": "operation from handler: operation-name successful",
    "data": { /* object or array */ }
}

// Error
{
    "message": "error message",
    "errorCode": 400
}
```

### Handler Initialization

Handlers must initialize global vars via `InitializeHandler()`:

```go
// handler/handler.go
var (
    logger *config.Logger
    db     *gorm.DB
)

func InitializeHandler() {
    logger = config.GetLogger("handler")
    db = config.GetSQLite()
}
```

**Called from**: router/routes.go → initializeRoutes() → handler.InitializeHandler()

### Logger Usage

Get a logger with package/context name:

```go
logger := config.GetLogger("package-name")

// Methods available:
logger.Debug(v...)           // Println style
logger.Debugf(format, v...)  // Printf style
logger.Info(v...)            // Info level
logger.Infof(format, v...)   
logger.Warn(v...)            // Warning level
logger.Warnf(format, v...)   
logger.Error(v...)           // Error level
logger.Errorf(format, v...)  
```

Output format: `LEVEL: [date time] [package] message`

### Swagger Documentation

Document endpoints with comments above handler functions. Example:

```go
// @BasePath /api/v1
// @Summary Create opening
// @Description Create a new job opening
// @Tags Openings
// @Accept json
// @Produce json
// @Param request body CreateOpeningRequest true "Request body"
// @Success 200 {object} CreateOpeningResponse
// @Failure 400 {object} ErrorResponse
// @Failure 500 {object} ErrorResponse
// @Router /opening [post]
func CreateOpeningHandler(ctx *gin.Context) {
    // ...
}
```

**Regenerate**: `make docs` or `swag init`

---

## Naming Conventions

### File Naming

- **CamelCase** for Go files: `createOpening.go`, `updateOpening.go`
- Note: Typo in `createOpenining.go` (extra 'i') - file exists as-is
- Descriptive action names: `{action}{Resource}.go`

### Function Naming

- **PascalCase** for exported functions: `CreateOpeningHandler`, `ListOpeningsHandler`
- Handler functions follow: `{Action}{Resource}Handler`
- Private helpers: `camelCase`

### Struct Naming

- Models in `schemas/`: `Opening`, `OpeningResponse`
- Request/Response DTOs: `{Action}OpeningRequest`, `{Action}OpeningResponse`
- Gin responses use `gin.H` for simple responses

### Variable Naming

- Single resource: `opening` (lowercase)
- Multiple resources: `openings` (lowercase plural)
- Avoid abbreviations except standard Go conventions (`db`, `err`, `ctx`)

---

## Development Workflow

### Adding a New Endpoint

1. **Add route** in router/routes.go → v1 group
2. **Create handler** in handler/{action}{Resource}.go with Swagger comments
3. **Define request/response** structs in handler/request.go and handler/response.go
4. **Implement validation** in request struct Validate() method
5. **Implement logic** - use `db` (GORM) and `logger` globals initialized in InitializeHandler
6. **Regenerate docs**: `make docs`
7. **Test**: Use Swagger UI or curl

### Adding a New Model

1. Define struct with GORM tags in schemas/
2. Add model to auto-migration in config/sqlite.go → `db.AutoMigrate(&YourModel{})`
3. Use in handlers with `db.Create()`, `db.First()`, `db.Find()`, `db.Save()`, `db.Delete()`

### Database Operations

Database instance is global `db *gorm.DB` in handler package. Common patterns:

```go
// Create
db.Create(&opening)

// Find by ID
db.First(&opening, id)

// List all
db.Find(&openings)

// Update
db.Save(&opening)

// Delete (soft delete with DeletedAt timestamp)
db.Delete(&opening)

// Always check error
if err := db.SomeOperation(&model).Error; err != nil {
    logger.Errorf("Operation error: %v", err)
}
```

GORM uses soft deletes (DeletedAt field from gorm.Model).

---

## Important Gotchas & Non-Obvious Patterns

### 1. **Remote Field is a Pointer**

```go
Remote *bool  // NOT bool
```

Why: Allows null values to distinguish "not specified" from "false". Always use pointers for optional booleans in request/response.

### 2. **Request Struct Validation Logic is Asymmetric**

**CreateOpeningRequest.Validate()**: All fields required (AND logic - all must be present)

```go
if r.Role == "" && r.Company == "" ... && r.Salary == 0 {
    return fmt.Errorf("request body is empty")
}
```

**UpdateOpeningRequest.Validate()**: Inverse logic - returns nil if ANY field is empty (partial updates allowed)

```go
if r.Role == "" || r.Company == "" ... || r.Salary == 0 {
    return nil  // At least one field is missing - this is OK for updates
}
return fmt.Errorf("at least one valid field...")
```

**Pattern**: Create requires all fields; Update allows partial updates.

### 3. **Config Initialization Chain**

```
main() → config.Init() → InitializeSQLite() → auto-migration
                      → router.Initialize() → initializeRoutes() → handler.InitializeHandler()
```

Handlers are initialized AFTER database. If you need DB in another layer, ensure proper init order.

### 4. **BindJSON Without Error Check**

```go
ctx.BindJSON(&request)  // No error check in current code
```

Currently code doesn't explicitly check BindJSON errors. Request with bad JSON will fail silently in some cases. Consider adding error handling if strict JSON validation needed.

### 5. **Swagger Docs Must Be Regenerated**

Swagger comments are parsed by `swag init` command. Changes to:
- Parameter names/types
- Response structures
- Field tags

...require running `make docs` or `make run-with-docs` to regenerate docs/swagger.json.

### 6. **Database Path is Hardcoded**

Database always created at `./db/main.db` regardless of working directory or environment. Path is relative and depends on where `go run` is executed.

### 7. **Global Variables in Packages**

Both `config`, `handler`, and `router` use package-level globals:
- `handler.logger` and `handler.db`
- `config.db` and `config.logger`

These are initialized on startup and reused. Not thread-safe for reinitialization, but fine for single startup initialization pattern used here.

### 8. **Handler Name Typo**

File is `createOpenining.go` (double 'i') - this is the actual filename, not a typo to fix.

---

## Testing

Current test command: `make test` → `go test ./ ...`

The repository has minimal/no test files currently. Add tests with:

```bash
go test -v ./...              # Verbose, all packages
go test ./handler -v          # Specific package
go test -cover ./...          # With coverage
```

Suggested test structure:
- `handler/*_test.go` for handler tests
- `config/*_test.go` for config tests
- Use `testing.T` and table-driven tests

---

## Dependencies

### Direct Dependencies (go.mod)

- **github.com/gin-gonic/gin** (v1.11.0) - Web framework
- **github.com/swaggo/files** (v1.0.1) - Swagger static files
- **github.com/swaggo/gin-swagger** (v1.6.1) - Swagger UI for Gin
- **github.com/swaggo/swag** (v1.16.6) - Swagger doc generator
- **gorm.io/driver/sqlite** (v1.6.0) - SQLite driver
- **gorm.io/gorm** (v1.31.1) - ORM

### Key Indirect Dependencies

- Gin: Validation, routing, middleware
- GORM: Database abstraction, migrations
- Swagger: API documentation generation

---

## Configuration & Environment

### Environment Variables

```
PORT           # Server port (default: 8080)
```

Set with: `export PORT=3000` (Unix/Linux/Mac) or `set PORT=3000` (Windows)

### Database Configuration

- **Type**: SQLite
- **Path**: `./db/main.db` (created on first run)
- **Auto-migration**: Enabled - schemas/Opening auto-migrated on startup
- **Soft deletes**: Enabled (DeletedAt timestamp)

### Logger Configuration

- **Output**: stdout
- **Format**: `LEVEL: [date time] [package-name] message`
- **Levels**: Debug, Info, Warning, Error

---

## Common Tasks

### Debug a Handler

1. Add logger statements: `logger.Infof("value: %v", variable)`
2. Run: `make run-with-docs`
3. Check console output for DEBUG/INFO messages
4. Use Swagger UI at http://localhost:8080/swagger/index.html to trigger endpoints

### Add a New Database Field

1. Add field to `schemas.Opening` struct with GORM/JSON tags
2. Run `make clean` to remove old DB
3. Run `make run-with-docs` - auto-migration creates new schema
4. Add to request/response structs
5. Update validation logic
6. Regenerate docs: `make docs`

### Test an Endpoint

**Option A - Swagger UI**: Navigate to http://localhost:8080/swagger/index.html

**Option B - curl**:
```bash
curl -X POST http://localhost:8080/api/v1/opening \
  -H "Content-Type: application/json" \
  -d '{"role":"Go Dev","company":"Acme","location":"Remote","remote":true,"link":"https://...","salary":100000}'
```

### Generate Fresh Documentation

```bash
make docs
```

Regenerates docs/swagger.json and docs/swagger.yaml from Swagger comments in handlers.

---

## Git Workflow

### Recent Commits (Context)

```
65a3f86 fix: swagger documentation
432339f docs: swagger documentarion
70871e8 feat: add makefile and swagger logic
```

### Commit Message Convention

- `feat:` - New features
- `fix:` - Bug fixes
- `docs:` - Documentation changes
- `refactor:` - Code refactoring without feature changes

Example: `git commit -m "feat: add delete opening endpoint"`

---

## Performance & Scalability Considerations

- **SQLite limitations**: Single-file database, suitable for development/small scale. Consider PostgreSQL/MySQL for production.
- **Global database connection**: Single `gorm.DB` instance shared across requests. Gin handles concurrency.
- **No connection pooling config**: Uses GORM defaults. May need tuning for high load.
- **Logging to stdout**: Suitable for development. Consider file/structured logging for production.

---

## Security Notes

- **No authentication**: API endpoints have no auth/authorization. Add middleware for production.
- **No HTTPS enforcement**: Server listens on plain HTTP. Add TLS in production.
- **No input sanitization beyond validation**: Relies on GORM parameter binding. Review for SQL injection (should be safe with GORM).
- **CORS not configured**: Add CORS middleware if frontend accessed from different domain.

---

## Useful Links & References

- [Gin Documentation](https://gin-gonic.com/)
- [GORM Documentation](https://gorm.io/)
- [Swag (Swagger for Go)](https://github.com/swaggo/swag)
- [OpenAPI/Swagger Spec](https://swagger.io/specification/)

---

**Last Updated**: 2026-01-10  
**Go Version**: 1.25.5  
**Main Dependencies**: Gin, GORM, SQLite, Swagger
